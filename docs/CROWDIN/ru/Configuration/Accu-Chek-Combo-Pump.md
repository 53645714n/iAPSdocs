# Помпа Accu Chek Combo

**Настоящее ПО является частью самодеятельной разработки, а не готовым программным продуктом. От ВАС потребуется прочитать, изучить и понять систему и то, как ей пользоваться. Она не контролирует диабет за вас, но позволит улучшить компенсацию и качество жизни, если вы готовы уделить ей достаточно времени. Не бросайтесь в систему сломя голову, дайте себе время на изучение. Только вы несете ответственность за то, что вы с ней делаете.**

## Требования к оборудованию

- Помпа Roche Accu-Chek Combo (любая версия прошивки, работают все)
- Устройство Smartpix или Realtyme с приложением "360" для конфигурирования помпы под свои параметры. По вашему запросу фирма Roche бесплатно вышлет устройства и ПО. (как всегда, Россия здесь исключение. По крайней мере, переводчику данной документации ничего не выслали. Возможно, надо разговаривать с сотрудниками или руководителями фирмы, а не с агентами, чьи контакты нам обычно дают при установке помпы).
- Совместимый смартфон: телефон на Android с прошивкой LineageOS 14.1 (прежнее название - CyanogenMod) или Android 8.1 (Oreo). LineageOS 14.1 должна иметь свежую версию, по крайней мере от июня 2017, когда в прошивку включили изменения, позволяющие соединяться с помпой Combo. Список телефонов можно найти в документе [Телефоны, работающие с AAPS](https://docs.google.com/spreadsheets/d/1gZAsN6f0gv6tkgy9EBsYl0BQNhna0RDqA9QGycAqCQc/edit#gid=698881435). Пожалуйста, имейте в виду, что это не полный список и отражает личный опыт пользователя. Вам предлагается также делиться результатами вашего опыта и тем самым помогать другим (все подобные проекты основаны на идеологии бескорыстной помощи).

- Имейте в виду, что хотя Android 8.1 позволяет общаться с Комбо, по-прежнему есть проблемы с AAPS на 8.1. Опытные пользователи имеют возможность выполнить сопряжение на рутованном телефоне и передать настройки на другой рутованный телефон для работы с утилитой ruffy/AAPS. Такой подход позволяет пользоваться телефонами с версиями Android ниже 8.1, но он еще достаточно не опробован. https://github.com/gregorybel/combo-pairing/blob/master/README.md

## Ограничения

- Пролонгированный болюс и многоволновый болюс не поддерживаются (вместо них см. [Расширенные углеводы](../Usage/Extended-Carbs.rst))
- Поддерживается только один базальной профиль.
- Установка профиля, отличного от заданного на помпе или подача пролонгированного/многоволнового болюса с помпы конфликтует с временной скоростью базала TBR и приводит алгоритм ИПЖ к работе только в режиме приостановки на низких ГК в течение 6 часов поскольку безопасность работы цикла при этом нарушается.
- В настоящее время невозможно задать дату и время на помпе, поэтому переходы с/на летнее/зимнее время должны производиться вручную (вы можете деактивировать автоматический переход на телефоне вечером и утром изменить время на помпе и часах, чтобы избежать срабатывания сигнала оповещения ночью). (На территории России неактуально).
- В настоящее время поддерживаются только величины базала от 0.05 до 10 ед./час. Это также относится к изменениям профиля, например, при увеличении до 200% наивысшая скорость базала не должна превышать 5 ед/час, поскольку она удвоится. Аналогично, при снижении на 50%, самая низкая базальная скорость не должна быть меньше 0,10 U/ч.
- Если алгоритм цикла запрашивает отмену текущей временной скорости базала TBR, Combo на 15 минут установит TBR в 90% или 110%. Это происходит потому, что отмена TBR вызывает оповещение и вибрации на помпе.
- Периодически (раз в несколько дней) AAPS может дать сбой оповещения TBR ОТМЕНЕН при автоматической отмене TBR. Пользователю придется самостоятельно разобраться с этим (нажав кнопку "обновить" в AAPS для передачи предупреждения в программу или подтвердив получение оповещения кнопкой помпы).
- Bluetooth connection stability varies with different phones, causing "pump unreachable" alerts, where no connection to the pump is established anymore. Если возникает эта ошибка, убедитесь, что Bluetooth включен, нажмите кнопку "обновить" на вкладке Комбо и проверьте, устранена ли проблема и если соединение не восстановится, перезагрузите телефон, что обычно исправляет ошибку. Есть другая проблема, при которой перезапуск не помогает. В этом случае следует нажать на помпе кнопку (которая перезапустит bluetooth помпы) и помпа снова начнет принимать соединение с телефоном. В настоящее время мало что можно сделать для устранения этих проблем. Поэтому если подобные ошибки повторяются часто, подберите себе другой телефон, о котором известно, что он хорошо работает с AndroidAPS и Комбо (см. выше).
- Issuing a bolus from the pump will not always be detected in time (checked for whenever AAPS connects to the pump), and might take up to 20 minutes in the worst case. Болюсы помпы проверяются перед высоким временным базалом TBR или болюсом, подаваемым с AAPS, но из-за встроенных ограничений AAPS откажется подавать TBR/болюс т. к. его расчет производился на неверных основаниях. (-> Не подавайте болюс с помпы! См. раздел *Применение*)
- Следует избегать программирования временного базала TBR на помпе, так как контроль над TBR задается алгоритмом AAPS. Обнаружение нового временного базала TBR на помпе может занять до 20 минут, а его действие принимается в расчет алгоритмом AAPS с момента обнаружения, так что в худшем случае TBR не будет учтен как активный инсулин IOB в течении 20 минут. 

## Настройки

- Настройте помпу с помощью конфигурирующей программы 360. Если у вас нет этой программы, обратитесь в службу поддержки Акку-Чек. Обычно они высылают диск с программой "360° Pump Configuration Software" и устройство инфракрасной связи SmartPix зарегистрированным пользователям (устройство Realtyme также годится для этих целей). 
  - Требуется (на снимках экрана отмечено зеленым): 
    - Установите/оставьте конфигурацию меню как "Стандартная", в результате будут показаны только поддерживаемые меню/действия на помпе и уберутся неподдерживаемые (пролонгированный/многоволновый болюс, множественные скорости базала), которые ограничивают функционал помпы в безопасном режиме AAPS.
    - Убедитесь, что *Краткие сведения - текст* установлен на "КРАТКИЕ СВЕДЕНИЯ" (без кавычек, в разделе *Параметры инсулиновой помпы*).
    - Установите *Максимум корректировки* суммарной скорости базала TBR на 500%
    - Отключите *Сигнал окончания временного базала*
    - Установите *приращение длительности* временного базала на 15 мин
    - Включите Bluetooth
  - Рекомендуется (отмечено синим на снимках экрана) 
    - Установите сигнал оповещения о малом количестве инсулина в картридже на величину по своему усмотрению
    - Настройте максимальную величину болюса в соответствии с требованиями вашей терапии, но имея в виду защиту от ошибок в программном обеспечении
    - Аналогичным образом настройте максимальную продолжительность временного базала TBR на безопасный уровень. Установите эту величину по крайней мере на 3 часа, так как опция отключения помпы задает базал в виде 0% на 3 часа.
    - Включите кодовую блокировку помпы для предотвращения быстрой подачи болюса, особенно если быстрая подача болюса с помпы была в привычке до перехода на AAPS.
    - Задайте таймаут отключения экрана и меню минимум на 5,5 и 5 соответственно. Это позволяет AAPS быстрее восстановиться после ошибок и уменьшает количество вибраций во время таких ошибок

![Снимок экрана меню параметров пользователя](../images/combo/combo-menu-settings.png)

![Снимок экрана параметров TBR](../images/combo/combo-tbr-settings.png)

![Снимок экрана настроек болюса](../images/combo/combo-bolus-settings.png)

![Снимок экрана настроек для картриджей инсулина](../images/combo/combo-insulin-settings.png)

- Установите AndroidAPS по инструкции [AndroidAPS](http://wiki.AndroidAPS.org).
- Для правильной работы с программой внимательно прочитайте документацию.
- На этом этапе в настройках AAPS в разделе выбор помпы выберите MDI а не Комбо чтобы избежать вмешательства в работу утилиты ruffy во время установки сопряжения.
- Следуйте по ссылке <http://ruffy.AndroidAPS.org> и клонируйте ruffy через git.
- Установите утилиту ruffy и используйте ее для сопряжения с помпой. Если она не сработает после нескольких попыток, переключитесь на ветку `сопряжение`, установите связь с помпой и затем переключитесь обратно на исходную ветку. Обратите внимание, что сопряжение - процесс хрупкий (но выполняется всего один раз) и, возможно, потребуется несколько попыток; своевременно реагируйте на запросы и, при необходимости повторить попытку, заранее удаляйте помпу из параметров Bluetooth. Можно попробовать другой вариант, который заключается в том, чтобы после начала процесса сопряжения войти в меню Bluetooth (это делает Bluetooth телефона видимым на время отображения в меню) и после подтверждения сопряжения, когда помпа показывает код авторизации, переключиться обратно на алгоритм. Если вам не удалось настроить соединение с помпой (скажем, после 10 попыток) попробуйте подождать до 10 секунд, прежде чем подтвердить соединение на помпе (когда наименование телефона появилось на помпе). Если вы установили срок ожидания меню на 5 секунд, увеличьте его. Некоторые пользователи сообщают, что им приходилось так делать. Наконец, попробуйте переместиться из одной комнаты в другую, чтобы избежать помех связи. Один из пользователей сообщил нам об устранении проблем соединения сразу же после перемены комнат.
- Когда AAPS пользуется алгоритмом ruffy, утилита ruffy недоступна. Самым простым выходом в этом случае является перезагрузить телефон после сопряжения и дать возможность алгоритму ruffy запуститься в фоновом режиме.
- Если помпа совершенно новая, требуется подать болюс на помпе, чтобы помпа произвела первую запись в логе.
- Прежде чем активировать расширение Combo в AAPS, убедитесь в правильной настройке профиля и в его активации (!) и что профиль базала актуален т. к. AAPS будет синхронизировать профиль с помпой. После этого активируйте расширение Combo. Нажмите кнопку *Обновить* на вкладке Combo для запуска помпы.
- Для проверки настроек, при отключенной помпе в режиме **отключено**, задайте в AAPS значение временного базала TBR 500% на 15 мин и подайте болюс. После этого в логах помпы появится работающий TBR и болюс. AAPS должен также показать активный TBR и поданный болюс.

## Почему утилите "ruffy" не удается установить сопряжение с помпой?

Существует несколько возможных причин. Попробуйте следующие действия:

1. Вставьте в помпу **свежие или полностью заряженные батареи**. Подробнее см. в разделе "батарея". Убедитесь, что помпа находится вблизи смартфона.

![Помпа Combo должна находиться рядом с телефоном](../images/Combo_next_to_Phone.png)

2. Отключите или удалите любые другие устройства bluetooth, чтобы они не смогли установить подключение к телефону во время сопряжения. Любая параллельная связь по bluetooth или запрос на соединение могут нарушить процесс сопряжения.

3.     Удалите уже подключенные устройства в меню Bluetooth помпы: ** настройки BLUETOOTH / подключение / удалить ** до появления сообщения 
      ** NO DEVICE ** (нет устройств).
      

4. Удалите помпу, уже подключенную к телефону через Bluetooth: Параметры / Bluetooth, Удалить сопряженное устройство «**SpiritCombo**»
5. Убедитесь, что AAPS не работает в фоновом режиме цикла. Деактивируйте цикл в AAPS.
6. Запустите утилиту ruffy на телефоне. Можно нажать Reset! (Перезапустить) и удалить старое сопряжение. Затем нажать Connect! (Подключиться).
7. В меню Bluetooth помпы, перейдите к **Добавить устройство / добавить подключение**. Press *CONNECT!** * Step 5 and 6 have to be done in a short timing.
8. Now the Pump should show up the BT Name of phone to select for pairing. Here it is important to wait at least 5s before you hit the select button on Pump. Otherwise the Pump will not send the Pairing request to the Phone properly.

* If Combo Pump is set to 5s Screen timeout, you may test it with 40s (original setting). From experience the time between pump is showing up in phone until select phone is around 5-10s. In many other cases pairing just times out without successfully Pair. Later you should set it back to 5s, to meet AAPS Combo settings. * If the pump does not show the phone as a pairing device at all, your phone's Bluetooth stack is probably not compatible with the pump. Make sure you are running a new **LineageOS ≥ 14.1** or **Android ≥ 8.1 (Oreo)**. If possible, try another smartphone. You can find a list of already successfully used smartphones under \[AAPS Phones\] (https://docs.google.com/spreadsheets/d/1gZAsN6f0gv6tkgy9EBsYl0BQNhna0RDqA9QGycAqCQc/edit#gid=698881435).

9. At next Pump should show up a 10 digit security code. And Ruffy a screen to enter it. So enter it in Ruffy and you should be ready to go.
10. Reboot the phone.
11. Now you can restart AAPS loop.

## Применение

- Имейте в виду, что это не конечный продукт, особенно на начальном этапе пользователь должен научиться контролировать и понимать систему, ее ограничения и возможные сбои в работе. Настоятельно рекомендуем не пользоваться системой, если нет полного понимания принципов ее работы.
- Изучите документацию по OpenAPS, чтобы понять алгоритм работы AndroidAPS, на ней основанный.
- Читайте базу знаний wiki, чтобы ознакомиться и понять AndroidAPS http://wiki.AndroidAPS.org
- Данная интеграция обладает той же функциональностью что и пульт - глюкометр, поставляемый в комплекте с помпой. Глюкометр позволяет дублировать экран помпы и перенаправляет на помпу все команды (эквивалентные нажатию кнопок на помпе). Связь с помпой, равно как и это перенаправление команд является главным функционалом алгоритма приложения. Компоненты `скриптера` считывают информацию с экрана и автоматизируют подачу болюсов, временного базала TBR; проверяют корректность обработки введенных данных. Алгоритм ИПЖ затем обменивается данными со скриптером, применяет команды цикла и подает болюсы. Этот режим имеет некоторые ограничения: он действует медленно (но достаточно быстро для своих задач), и изменение временного базала TBR или подача болюса приводит к вибрации помпы.
- Интеграция Combo с AndroidAPS исходит из того, что все входные данные проводятся через AndroidAPS. Болюсы, подаваемые непосредственно с помпы, будут обнаружены алгоритмом AAPS, но на это может уйти до 20 минут. Считывание болюсов, поданных непосредственно с помпы - мера предосторожности, которая не предназначена для регулярной работы (алгоритм ИПЖ требует информации о потребленных углеводах, которая не может поступать с помпы, и это еще одна причина, по которой ввод данных должен происходить через интерфейс приложения). 
- Не устанавливайте и не отменяйте временный базал TBR на помпе. Алгоритм AAPS предполагает контроль над временным базалом, он не будет работать надежно при иных решениях, поскольку начало подачи временного базала, заданного пользователем на помпе, невозможно определить.
- Первый базальный профиль помпы считывается при запуске приложения и обновляется алгоритмом AAPS. Скорость подачи базала не должна меняться вручную на помпе, но будет обнаружена и скорректирована как мера безопасности (не полагайтесь на меры безопасности, задаваемые по умолчанию, они предназначены для обнаружения непреднамеренных изменений на помпе).
- Рекомендуется включить кодовую блокировку на помпе для предотвращения случайной подачи болюса с помпы, особенно если вы уже пользовались помпой раньше и подача "быстрого болюса" вошла в привычку. Помимо этого, при активной блокировке, случайное нажатие на кнопку помпы НЕ прерывает коммуникацию между AAPS и помпой.
- Когда на помпе срабатывает оповещение ОТМЕНА БОЛЮСА / врем. базала TBR во время подачи болюса или установки врем. базала TBR, что иногда бывает, то это вызывается потерей соединения между помпой и телефоном. AAPS будет пытаться восстановить соединение, подтвердить сигнал и повторно выполнить последнее действие (болюсы не повторяются из соображений безопасности). Таким образом, это оповещение можно проигнорировать т. к. AAPS подтверждает его автоматически, обычно в течение 30 секунд (отменить его не составляет труда, но приведет к тому, что исполняемое в данный момент действие будет приостановлено до того, как экран помпы погаснет и ваше устройство вновь не подключится к помпе). If the pump's alarm continues, automatic confirmation failed, in which case the user needs to confirm the alarm manually.
- Когда оповещение о заканчивающемся инсулине или низком заряде батареи срабатывает во время болюса, они подтверждаются автоматически и появляются в AAPS в виде уведомления. Если они срабатывают в момент отсутствия связи с помпой, нажатие кнопки "обновить" (refresh) на вкладке Combo подтвердит получение сигнала и подаст уведомление в AAPS.
- Когда подтверждение получения сигнала об отмене скорости временного базала (TBR CANCELLED) не срабатывает в AAPS или когда срабатывает другое оповещение, нажатие кнопки "обновить" (refresh) на вкладке Combo восстановит соединение, подтвердит получение сигнала и подаст уведомление в AAPS. Такие манипуляции безопасны ввиду безопасности самих оповещений - соответствующая скорость временного базала будет снова задана во время следующего цикла работы алгоритма.
- Для всех других оповещений, инициируемых помпой: подключение к помпе покажет оповещение во вкладке Combo, например «состояние: Е4: закупорка», которое дублируется на главном экране. Любая ошибка системы генерирует срочное уведомление. AAPS никогда самостоятельно не подтверждает получения оповещений о серьезных ошибках и дает возможность помпе сигналить и вибрировать, чтобы пользователь имел возможность самостоятельно удостовериться в наличии критической ситуации, требующей его действий.
- После установки соединения с помпой, не следует запускать утилиту ruffy (AAPS, как ему и следует, запустится в фоновом режиме); независимая работа утилиты ruffy не предусмотрена.
- Если AAPS прекращает работу (в результате серьезной ошибки или останавливается из отладчика) когда телефон с AAPS и помпа обмениваются данными (при помощи ruffy), возможно потребуется принудительная остановка ruffy. Перезапуск приложения AAPS перезапустит и ruffy. Перезапуск телефона - простой способ устранить проблему, если вы не знаете, как принудительно убить все процессы приложения.
- Не нажимайте никаких кнопок на помпе во время обмена данными между AAPS и помпой (на экране помпы в это время высвечивается логотип блутуса).